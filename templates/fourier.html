{% extends "base.html" %}
{% block content %}
  <!-- Page Header -->
  <div class="page-header" style="margin-bottom: 30px; text-align: center;">
    <h1 style="font-size: 2.5em; margin-bottom: 10px;">Fourier Transform Visualizer</h1>
    <p style="font-size: 1.1em; color: #555; max-width: 600px; margin: 0 auto;">
      Enter a time-domain function to compute and visualize its Fourier transform. Use the quick buttons for common functions, adjust phase shift, and toggle zero-edge display for deeper analysis.
    </p>
  </div>

  <form id="fourierForm" method="POST" style="max-width: 700px; margin: 0 auto; text-align: center;">
    <div class="function-group" style="margin-bottom: 20px;">
      <label for="func" style="display: block; font-weight: bold; margin-bottom: 5px;">Function:</label>
      <input type="text" id="func" name="func"
             value="{{ func|default('') }}"
             placeholder="e.g., sin(t) + 3*rect(t)"
             onfocus="setActiveField(this)">
      <!-- First line: function operands -->
      <div class="quick-buttons" style="margin-top: 10px;">
        <button type="button" onclick="insertOperand('rect(t)')">Rect</button>
        <button type="button" onclick="insertOperand('tri(t)')">Tri</button>
        <button type="button" onclick="insertOperand('sin(t)')">Sin</button>
        <button type="button" onclick="insertOperand('step(t)')">Step</button>
        <button type="button" onclick="insertOperand('cos(t)')">Cos</button>
        <button type="button" onclick="insertOperand('sign(t)')">Sign</button>
        <button type="button" onclick="insertOperand('delta(t)')">Delta</button>
        <button type="button" onclick="insertOperand('exp_iwt(t)')">e^(iωt)</button>
        <button type="button" onclick="insertOperand('exp(t)')">Exp</button>
        <button type="button" onclick="insertOperand('inv_t(t)')">1/t</button>
        <button type="button" onclick="insertOperand('si(t)')">Si</button>
        <button type="button" onclick="insertOperand('si(t)**2')">Si²</button>
      </div>
      <!-- Second line: operators -->
      <div class="quick-buttons" style="margin-top: 5px;">
        <button type="button" onclick="insertOperand('+')">+</button>
        <button type="button" onclick="insertOperand('-')">-</button>
        <button type="button" onclick="insertOperand('*')">*</button>
        <button type="button" onclick="insertOperand('/')">/</button>
      </div>
    </div>

    <div class="options-group" style="display: flex; gap: 20px; justify-content: center; align-items: center; margin-bottom: 30px;">
      <div>
        <label for="phase" style="font-weight: bold;">Phase Shift (°):</label>
        <input type="number" id="phase" name="phase" value="{{ phase|default(0) }}" placeholder="0">
      </div>
      <div>
        <input type="checkbox" id="showZeros" name="showZeros" {% if show_zeros %}checked{% endif %}>
        <label for="showZeros">Show Zeros (Edges)</label>
      </div>
    </div>

    <div style="margin-bottom: 30px;">
      <button type="submit" class="action-btn">Compute</button>
      <button type="button" id="clearBtn" class="action-btn">Clear</button>
    </div>
  </form>

  <div id="fourier-plot-wrapper">
    {% if plot_data %}
      <img id="fourier_plot_image" src="data:image/png;base64,{{ plot_data }}" alt="Fourier Plot">
    {% else %}
      <img id="fourier_plot_image" src="" alt="Fourier Plot will appear here" style="display:none;">
    {% endif %}
    <button type="button" id="enlargeBtn" onclick="toggleEnlargePlot()">Enlarge Plot</button>
    <p id="fourier_transformation_label">{{ transformation_label }}</p>
  </div>

  <script>
  var activeField = null;
  function setActiveField(field) {
      activeField = field;
  }
  document.getElementById("func").addEventListener("focus", function() { activeField = this; });
  
  function insertOperand(operand) {
      if (activeField) {
          let start = activeField.selectionStart;
          let end = activeField.selectionEnd;
          let current = activeField.value;
          activeField.value = current.substring(0, start) + operand + current.substring(end);
          activeField.selectionStart = activeField.selectionEnd = start + operand.length;
          activeField.focus();
          updateFourierLive();
      } else {
          alert("Click in an input field first.");
      }
  }
  
  function debounce(func, wait) {
      let timeout;
      return function() {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, arguments), wait);
      };
  }
  
  function getFourierValues() {
      return {
          func: document.getElementById("func").value,
          phase: document.getElementById("phase").value,
          showZeros: document.getElementById("showZeros").checked
      };
  }
  
  var updateFourierLive = debounce(function() {
      let values = getFourierValues();
      fetch("{{ url_for('fourier.update_fourier') }}", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(values)
      })
      .then(resp => resp.json())
      .then(data => {
          if(data.plot_data) {
              let img = document.getElementById("fourier_plot_image");
              img.src = "data:image/png;base64," + data.plot_data;
              img.style.display = "block";
              document.getElementById("fourier_transformation_label").innerText = data.transformation_label;
          }
      })
      .catch(err => {
          console.error("Error updating plot:", err);
      });
  }, 400);
  
  document.getElementById("phase").addEventListener("input", updateFourierLive);
  document.getElementById("func").addEventListener("keyup", updateFourierLive);
  document.getElementById("showZeros").addEventListener("change", updateFourierLive);
  
  document.getElementById("clearBtn").addEventListener("click", function() {
      document.getElementById("func").value = "";
      document.getElementById("fourier_plot_image").src = "";
      document.getElementById("fourier_plot_image").style.display = "none";
      document.getElementById("phase").value = 0;
      document.getElementById("showZeros").checked = false;
  });
  
  // Toggle enlarge by applying a class to the whole plot wrapper.
  function toggleEnlargePlot() {
      let wrapper = document.getElementById("fourier-plot-wrapper");
      if (!wrapper) {
          console.error("Plot wrapper not found.");
          return;
      }
      wrapper.classList.toggle("enlarged");
  }
</script>

  <style>
    /* Header */
    .page-header h1 { font-weight: bold; }
    .page-header p { line-height: 1.4; }

    /* Input styling */
    .function-group input[type="text"], .options-group input[type="number"] {
      width: 100%;
      max-width: 300px;
      padding: 8px;
      border: 1px solid #ccd0d5;
      border-radius: 4px;
      font-size: 1em;
      margin-top: 5px;
    }

    /* Quick buttons */
    .quick-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      justify-content: center;
    }
    .quick-buttons button {
      padding: 6px 10px;
      font-size: 0.9em;
      background-color: #007acc;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .quick-buttons button:hover {
      background-color: #005fa3;
    }

    /* Action buttons */
    .action-btn {
      padding: 10px 20px;
      font-size: 1em;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    /* Compute button (first .action-btn) */
    #fourierForm .action-btn:first-child {
      background-color: #007acc;
      color: #fff;
      margin-right: 10px;
    }
    #fourierForm .action-btn:first-child:hover {
      background-color: #005fa3;
    }
    /* Clear button */
    #clearBtn {
      background-color: #f44336;
      color: #fff;
    }
    #clearBtn:hover {
      background-color: #d32f2f;
    }

    /* Plot wrapper */
    #fourier-plot-wrapper {
      position: relative;
      text-align: center;
      margin: 30px auto;
      max-width: 90%;
    }
    #fourier_plot_image {
      max-width: 100%;
      border: 1px solid #ccd0d5;
      border-radius: 4px;
    }
    #fourier-plot-wrapper.enlarged {
      transform: scale(1.5);
      transform-origin: center center;
      transition: transform 0.3s ease;
    }
    #enlargeBtn {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 6px 10px;
      font-size: 0.9em;
      background-color: #007acc;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #enlargeBtn:hover {
      background-color: #005fa3;
    }
    #fourier_transformation_label {
      margin-top: 15px;
      white-space: pre-line;
      color: #333;
    }
  </style>
{% endblock %}