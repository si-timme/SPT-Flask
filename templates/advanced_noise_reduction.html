<!-- templates/advanced_noise_reduction.html -->

{% extends "base.html" %}
{% block content %}
<h2>Advanced Noise Reduction Module</h2>

{% if error %}
  <div style="color:red;">{{ error }}</div>
{% endif %}

<form method="post" enctype="multipart/form-data">
  <label>
    <input type="radio" name="audio_choice" value="default" checked>
    Use Example Audio
  </label>
  <label style="margin-left:1em;">
    <input type="radio" name="audio_choice" value="upload">
    Upload Your Own
  </label>
  <br><br>

  <div id="uploadDiv" style="display:none;">
    <label for="audio_file">Audio (WAV, â‰¤10 s):</label>
    <input type="file" name="audio_file" id="audio_file" accept=".wav">
    <br><br>
  </div>

  <label for="method">Noise Reduction Method:</label>
  <select name="method" id="method">
    <option value="wiener">Wiener Filter</option>
    <option value="spectral">Spectral Subtraction</option>
    <option value="wavelet">Wavelet Denoising</option>
  </select>
  <br><br>

  <button type="submit">Apply Noise Reduction</button>
</form>

<script>
  const radios = document.getElementsByName("audio_choice"),
        uploadDiv = document.getElementById("uploadDiv"),
        fileIn = document.getElementById("audio_file");
  radios.forEach(r => r.addEventListener("change", () => {
    if (r.value === "upload" && r.checked) {
      uploadDiv.style.display = "block";
      fileIn.required = true;
    } else if (r.value === "default" && r.checked) {
      uploadDiv.style.display = "none";
      fileIn.required = false;
    }
  }));
</script>

{% if time_plot and freq_plot and gain_plot %}
  <h3>Visualization</h3>
  <div style="display:flex;gap:20px;flex-wrap:wrap;">
    <div style="flex:1 1 30%;">
      <h4>Time Domain</h4>
      <img src="data:image/png;base64,{{ time_plot }}" alt="Time Domain Plot">
    </div>
    <div style="flex:1 1 30%;">
      <h4>Frequency Domain</h4>
      <img src="data:image/png;base64,{{ freq_plot }}" alt="Freq Domain Plot">
    </div>
    <div style="flex:1 1 30%;">
      <h4>Effective Gain (dB)</h4>
      <img src="data:image/png;base64,{{ gain_plot }}" alt="Gain Plot">
    </div>
  </div>
{% endif %}

{% if coef_plot %}
  <h3>Wavelet Coefficient Comparison</h3>
  <img src="data:image/png;base64,{{ coef_plot }}" alt="Wavelet Coefs">
{% endif %}

{% if output_audio %}
  <h3>Listen to Processed Audio</h3>
  <audio controls>
    <source src="data:audio/wav;base64,{{ output_audio }}" type="audio/wav">
  </audio>
  <h3>Download</h3>
  <a href="data:audio/wav;base64,{{ output_audio }}" download="denoised.wav">
    Download Denoised Audio
  </a>
{% endif %}
{% endblock %}
