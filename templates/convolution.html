{% extends "base.html" %}
{% block content %}
<h2>Convolution Calculator</h2>

<form id="convForm" method="POST">
  <div style="margin-bottom: 10px;">
    <label>Function 1:</label>
    <input type="text" id="func1" name="func1" value="{{ func1|default('') }}" placeholder="e.g. sin(t)">
  </div>
  <div style="margin-bottom: 10px;">
    <label>Function 2:</label>
    <input type="text" id="func2" name="func2" value="{{ func2|default('') }}" placeholder="e.g. step(t)">
  </div>
  
  <!-- Quick Functions / Operators -->
  <h4>Quick Functions & Operators</h4>
  <div id="quick-functions" style="margin-bottom:10px;">
    <button type="button" onclick="insertOperand('rect(t)')">Rect</button>
    <button type="button" onclick="insertOperand('tri(t)')">Tri</button>
    <button type="button" onclick="insertOperand('sin(t)')">Sin</button>
    <button type="button" onclick="insertOperand('step(t)')">Step</button>
    <button type="button" onclick="insertOperand('cos(t)')">Cos</button>
    <button type="button" onclick="insertOperand('sign(t)')">Sign</button>
    <button type="button" onclick="insertOperand('delta(t)')">Delta</button>
    <button type="button" onclick="insertOperand('exp_iwt(t)')">e^(iwt)</button>
    <button type="button" onclick="insertOperand('exp(t)')">Exp</button>
    <button type="button" onclick="insertOperand('inv_t(t)')">1/t</button>
    <button type="button" onclick="insertOperand('si(t)')">Si</button>
    <br>
    <button type="button" onclick="insertOperand('+')">+</button>
    <button type="button" onclick="insertOperand('-')">-</button>
    <button type="button" onclick="insertOperand('*')">*</button>
    <button type="button" onclick="insertOperand('/')">/</button>
  </div>

  <div style="margin-bottom: 10px;">
    <button type="submit">Compute Convolution</button>
    <button type="button" id="clearBtn">Clear</button>
  </div>

  {% if error %}
  <div style="color:red;">Error: {{ error }}</div>
  {% endif %}
</form>

<!-- Plot Container -->
<div id="conv-plot-wrapper" style="position: relative; margin-top:20px; display:inline-block;">
  {% if plot_data %}
    <img id="conv_plot_image" src="data:image/png;base64,{{ plot_data }}" alt="Convolution Plot">
  {% else %}
    <img id="conv_plot_image" src="" alt="Convolution Plot will appear here" style="display:none;">
  {% endif %}
  <!-- Enlarge button at top-right corner -->
  <button type="button" id="enlargeBtn" onclick="toggleEnlarge()" style="position:absolute; top:10px; right:10px;">
    Enlarge Plot
  </button>
</div>

<script>
  var activeField = null;
  let f1 = document.getElementById("func1");
  let f2 = document.getElementById("func2");

  // Insert quick function/operator into whichever input is active
  function insertOperand(operand) {
    if(!activeField) {
      alert("Select an input field first.");
      return;
    }
    let start = activeField.selectionStart;
    let end = activeField.selectionEnd;
    let current = activeField.value;
    activeField.value = current.substring(0, start) + operand + current.substring(end);
    activeField.selectionStart = activeField.selectionEnd = start + operand.length;
    activeField.focus();
  }

  // Track which field is active
  f1.addEventListener("focus", ()=>{ activeField=f1; });
  f2.addEventListener("focus", ()=>{ activeField=f2; });

  // Clear button
  document.getElementById("clearBtn").addEventListener("click", function(){
    f1.value = "";
    f2.value = "";
    let img = document.getElementById("conv_plot_image");
    img.src = "";
    img.style.display = "none";
  });

  // Toggle enlarge by applying a class to the wrapper
  function toggleEnlarge(){
    let wrapper = document.getElementById("conv-plot-wrapper");
    if(!wrapper) return;
    wrapper.classList.toggle("enlarged");
  }
</script>

<style>
  /* Enlarge the entire wrapper via transform scale, from center */
  #conv-plot-wrapper.enlarged {
    transform: scale(1.5);
    transform-origin: center center;
    transition: transform 0.3s ease;
  }
  #conv_plot_image {
    display: block;
    max-width: 100%;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
</style>
{% endblock %}
