{% extends "base.html" %}
{% block content %}
<div class="page-header" style="margin-bottom:30px; text-align:center;">
  <h1 style="font-size:2.5em;">Convolution Calculator</h1>
  <p style="color:#555; max-width:600px; margin:0 auto;">
    Gib zwei Zeitfunktionen ein und berechne deren diskrete Faltung interaktiv mit Plotly.
  </p>
</div>

<form id="convForm" style="max-width:700px; margin:0 auto; text-align:center;">
  <!-- Function 1 -->
  <div class="function-group" style="margin-bottom:20px;">
    <label style="font-weight:bold; display:block; margin-bottom:5px;">Function 1:</label>
    <input type="text" id="func1" placeholder="z.B. rect(t)" onfocus="setActiveField(this)"
           style="width:100%; max-width:300px; padding:10px; border:1px solid #ccd0d5; border-radius:4px; font-size:1em;" />
    <div class="quick-buttons functions" style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-top:10px;">
      <button type="button" onclick="insertOperand('rect(t)')">Rect</button>
      <button type="button" onclick="insertOperand('tri(t)')">Tri</button>
      <button type="button" onclick="insertOperand('sin(t)')">Sin</button>
      <button type="button" onclick="insertOperand('cos(t)')">Cos</button>
      <button type="button" onclick="insertOperand('step(t)')">Step</button>
      <button type="button" onclick="insertOperand('delta(t)')">Delta</button>
      <button type="button" onclick="insertOperand('sign(t)')">Sign</button>
      <button type="button" onclick="insertOperand('exp_iwt(t)')">e^(iωt)</button>
      <button type="button" onclick="insertOperand('exp(t)')">Exp</button>
      <button type="button" onclick="insertOperand('inv_t(t)')">1/t</button>
      <button type="button" onclick="insertOperand('si(t)')">Si</button>
      <button type="button" onclick="insertOperand('si(t)**2')">Si²</button>
    </div>
    <div class="quick-buttons operators" style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-top:5px;">
      <button type="button" onclick="insertOperand('+')">+</button>
      <button type="button" onclick="insertOperand('-')">-</button>
      <button type="button" onclick="insertOperand('*')">*</button>
      <button type="button" onclick="insertOperand('/')">/</button>
    </div>
  </div>

  <!-- Function 2 -->
  <div class="function-group" style="margin-bottom:20px;">
    <label style="font-weight:bold; display:block; margin-bottom:5px;">Function 2:</label>
    <input type="text" id="func2" placeholder="z.B. tri(t)" onfocus="setActiveField(this)"
           style="width:100%; max-width:300px; padding:10px; border:1px solid #ccd0d5; border-radius:4px; font-size:1em;" />
    <div class="quick-buttons functions" style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-top:10px;">
      <!-- dieselben Buttons wie oben -->
      <button type="button" onclick="insertOperand('rect(t)')">Rect</button>
      <button type="button" onclick="insertOperand('tri(t)')">Tri</button>
      <button type="button" onclick="insertOperand('sin(t)')">Sin</button>
      <button type="button" onclick="insertOperand('cos(t)')">Cos</button>
      <button type="button" onclick="insertOperand('step(t)')">Step</button>
      <button type="button" onclick="insertOperand('delta(t)')">Delta</button>
      <button type="button" onclick="insertOperand('sign(t)')">Sign</button>
      <button type="button" onclick="insertOperand('exp_iwt(t)')">e^(iωt)</button>
      <button type="button" onclick="insertOperand('exp(t)')">Exp</button>
      <button type="button" onclick="insertOperand('inv_t(t)')">1/t</button>
      <button type="button" onclick="insertOperand('si(t)')">Si</button>
      <button type="button" onclick="insertOperand('si(t)**2')">Si²</button>
    </div>
    <div class="quick-buttons operators" style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-top:5px;">
      <button type="button" onclick="insertOperand('+')">+</button>
      <button type="button" onclick="insertOperand('-')">-</button>
      <button type="button" onclick="insertOperand('*')">*</button>
      <button type="button" onclick="insertOperand('/')">/</button>
    </div>
  </div>

  <!-- Compute / Clear -->
  <div style="margin-bottom:30px;">
    <button type="button" id="computeBtn" class="action-btn">Compute</button>
    <button type="button" id="clearBtn"   class="action-btn">Clear</button>
  </div>
</form>

<!-- Plotly-Container -->
<div id="plotly-container" style="max-width:1200px; margin:0 auto;">
  <div id="plot1"      style="height:350px;"></div>
  <div id="plot2"      style="height:350px; margin-top:20px;"></div>
  <div id="plotConv"   style="height:350px; margin-top:20px;"></div>
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
let activeField = null;
function setActiveField(f){ activeField = f; }
document.getElementById("func1").addEventListener("focus", e=>activeField=e.target);
document.getElementById("func2").addEventListener("focus", e=>activeField=e.target);

function insertOperand(op) {
  if (!activeField) return alert("Klicke zuerst in das Textfeld!");
  const s = activeField.selectionStart, e = activeField.selectionEnd, v = activeField.value;
  activeField.value = v.slice(0,s) + op + v.slice(e);
  activeField.selectionStart = activeField.selectionEnd = s + op.length;
  activeField.focus();
}

function getValues() {
  return {
    func1: document.getElementById("func1").value,
    func2: document.getElementById("func2").value
  };
}

function updatePlots() {
  fetch("{{ url_for('convolution.convolution_update') }}", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(getValues())
  })
  .then(r=>r.json())
  .then(data=>{
    if(data.error) return console.error(data.error);
    const lc = { margin:{t:30}, showlegend:true };

    Plotly.newPlot("plot1", [{
      x:data.t, y:data.y1,
      type:"scatter", mode:"lines", name:"f₁(t)",
      line:{width:3, color:"blue"}
    }], {
      ...lc, title:"Function 1", xaxis:{title:"t"}, yaxis:{title:"f₁(t)"}
    });

    Plotly.newPlot("plot2", [{
      x:data.t, y:data.y2,
      type:"scatter", mode:"lines", name:"f₂(t)",
      line:{width:3, color:"green"}
    }], {
      ...lc, title:"Function 2", xaxis:{title:"t"}, yaxis:{title:"f₂(t)"}
    });

    Plotly.newPlot("plotConv", [{
      x:data.t, y:data.y_conv,
      type:"scatter", mode:"lines", name:"Convolution",
      line:{width:3, color:"black"}
    }], {
      ...lc, title:"f₁ * f₂ (Convolution)", xaxis:{title:"t"}, yaxis:{title:"(f₁*f₂)(t)"}
    });
  })
  .catch(console.error);
}

document.getElementById("computeBtn").addEventListener("click", updatePlots);
document.getElementById("clearBtn").addEventListener("click", ()=>{
  document.getElementById("func1").value="";
  document.getElementById("func2").value="";
  Plotly.purge("plot1");
  Plotly.purge("plot2");
  Plotly.purge("plotConv");
});
</script>

<style>
  /* Quick-Buttons (Functions & Operators) – etwas kompakter */
  .quick-buttons.functions button,
  .quick-buttons.operators button {
    padding: 8px 12px;        /* etwas weniger Innenabstand */
    font-size: 0.9em;         /* kleinere Schrift */
    min-width: 60px;          /* geringere Mindestbreite */
    border-radius: 4px;
    background-color: #007acc;
    color: #fff;
    border: none;
    cursor: pointer;
    transition: background-color 0.15s ease;
  }
  .quick-buttons.functions button:hover,
  .quick-buttons.operators button:hover {
    background-color: #005fa3;
  }

  /* Action-Buttons (Compute / Clear) – etwas kompakter */
  .action-btn {
    padding: 8px 20px;        /* weniger Innenabstand */
    font-size: 0.9em;         /* kleinere Schrift */
    border-radius: 4px;
    border: none;
    cursor: pointer;
    transition: background-color 0.15s ease;
  }
  #computeBtn {
    background-color: #28a745;
    color: #fff;
    margin-right: 6px;
  }
  #computeBtn:hover {
    background-color: #218838;
  }
  #clearBtn {
    background-color: #dc3545;
    color: #fff;
  }
  #clearBtn:hover {
    background-color: #c82333;
  }
</style>

{% endblock %}
